name: Deploy Docker to Alibaba ECS

on:
    push:
        branches:
            - main
            - staging

env:
    IMAGE_NAME: ${{ vars.DOCKER_USERNAME }}/fanfiction:latest

jobs:
    deploy:
        runs-on: ubuntu-latest
        environment: fanfiction-fr
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ vars.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and push Docker image
              uses: docker/build-push-action@v5
              with:
                  context: .
                  file: Dockerfile
                  push: true
                  tags: ${{ env.IMAGE_NAME }}

            - name: SSH deploy to ECS
              uses: appleboy/ssh-action@master
              env:
                  DJANGO_SETTINGS_MODULE: backend.settings_production
                  ALIYUN_BDD_NAME: ${{ secrets.ALIYUN_BDD_NAME }}
                  ALIYUN_BDD_USER: ${{ secrets.ALIYUN_BDD_USER }}
                  ALIYUN_BDD_PASSWORD: ${{ secrets.ALIYUN_BDD_PASSWORD }}
                  ALIYUN_BDD_HOST: ${{ secrets.ALIYUN_BDD_HOST }}
                  ALIYUN_BDD_PORT: ${{ secrets.ALIYUN_BDD_PORT }}
                  DOCKER_USERNAME: ${{ vars.DOCKER_USERNAME }}
                  DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
                  SECRET_KEY: ${{ secrets.SECRET_KEY }}
                  DEBUG: ${{ secrets.DEBUG }}
                  ADMIN_EMAIL: ${{secrets.ADMIN_EMAIL}}
                  ADMIN_NAME: ${{secrets.ADMIN_NAME}}
                  SENDGRID_SERVER: ${{secrets.SENDGRID_SERVER}}
                  SENDGRID_PORT: ${{secrets.SENDGRID_PORT}}
                  SENDGRID_USERNAME: ${{secrets.SENDGRID_USERNAME}}
                  SENDGRID_PASSWORD: ${{secrets.SENDGRID_PASSWORD}}
                  OSS_ACCESS_KEY_ID: ${{secrets.OSS_ACCESS_KEY_ID}}
                  OSS_ACCESS_KEY_SECRET: ${{secrets.OSS_ACCESS_KEY_SECRET}}
                  OSS_EXPIRE_TIME: ${{secrets.OSS_EXPIRE_TIME}}
                  OSS_BUCKET_NAME: ${{secrets.OSS_BUCKET_NAME}}
                  OSS_ENDPOINT: ${{secrets.OSS_ENDPOINT}}
                  RECAPTCHA_SECRET_KEY: ${{ secrets.RECAPTCHA_SECRET_KEY }}
              with:
                  host: ${{ secrets.ECS_HOST }}
                  username: ${{ secrets.ECS_USERNAME }}
                  key: ${{ secrets.ECS_SSH_KEY }}
                  port: ${{ secrets.ECS_SSH_PORT }}
                  timeout: 30s
                  command_timeout: 10m
                  envs: DJANGO_SETTINGS_MODULE,RECAPTCHA_SECRET_KEY,OSS_ACCESS_KEY_ID,OSS_ACCESS_KEY_SECRET,OSS_EXPIRE_TIME,OSS_BUCKET_NAME,OSS_ENDPOINT,SENDGRID_PASSWORD,SENDGRID_USERNAME,SENDGRID_PORT,SENDGRID_SERVER,ADMIN_EMAIL,ADMIN_NAME,ALIYUN_BDD_NAME,ALIYUN_BDD_USER,ALIYUN_BDD_PASSWORD,ALIYUN_BDD_HOST,ALIYUN_BDD_PORT,DOCKER_USERNAME,DOCKER_PASSWORD,SECRET_KEY,DEBUG
                  script: |
                      set -e  # Exit on any error
                      
                      # Debug: Print which variables are set (without values for security)
                      echo "=== Checking Environment Variables ==="
                      echo "DJANGO_SETTINGS_MODULE is set: ${DJANGO_SETTINGS_MODULE:+yes}"
                      echo "SECRET_KEY is set: ${SECRET_KEY:+yes}"
                      echo "DEBUG is set: ${DEBUG:+yes}"
                      echo "DOCKER_USERNAME is set: ${DOCKER_USERNAME:+yes}"
                      echo "DOCKER_PASSWORD is set: ${DOCKER_PASSWORD:+yes}"
                      echo "ALIYUN_BDD_NAME is set: ${ALIYUN_BDD_NAME:+yes}"
                      echo "ALIYUN_BDD_HOST is set: ${ALIYUN_BDD_HOST:+yes}"
                      
                      # login to docker hub
                      IMAGE_NAME="$DOCKER_USERNAME/fanfiction:latest"

                      echo "Logging in to Docker Hub..."
                      echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin

                      # run new container with the new image
                      echo "Pulling Docker image: $IMAGE_NAME"
                      docker pull $IMAGE_NAME
                      
                      echo "Stopping existing container..."
                      docker stop fanfiction || true
                      docker rm fanfiction || true

                      # create .env file to pass sensitive data
                      echo "Creating environment file..."
                      echo "DJANGO_SETTINGS_MODULE=backend.settings_production" > /tmp/fanfiction.env

                      # Append environment variables with proper quoting
                      {
                        echo "SECRET_KEY=${SECRET_KEY}"
                        echo "ALIYUN_BDD_NAME=${ALIYUN_BDD_NAME}"
                        echo "ALIYUN_BDD_USER=${ALIYUN_BDD_USER}"
                        echo "ALIYUN_BDD_PASSWORD=${ALIYUN_BDD_PASSWORD}"
                        echo "ALIYUN_BDD_HOST=${ALIYUN_BDD_HOST}"
                        echo "ALIYUN_BDD_PORT=${ALIYUN_BDD_PORT}"
                        echo "RECAPTCHA_SECRET_KEY=${RECAPTCHA_SECRET_KEY}"
                        echo "DEBUG=${DEBUG}"
                        echo "ADMIN_EMAIL=${ADMIN_EMAIL}"
                        echo "ADMIN_NAME=${ADMIN_NAME}"
                        echo "SENDGRID_SERVER=${SENDGRID_SERVER}"
                        echo "SENDGRID_PORT=${SENDGRID_PORT}"
                        echo "SENDGRID_USERNAME=${SENDGRID_USERNAME}"
                        echo "SENDGRID_PASSWORD=${SENDGRID_PASSWORD}"
                        echo "OSS_ACCESS_KEY_ID=${OSS_ACCESS_KEY_ID}"
                        echo "OSS_ACCESS_KEY_SECRET=${OSS_ACCESS_KEY_SECRET}"
                        echo "OSS_EXPIRE_TIME=${OSS_EXPIRE_TIME}"
                        echo "OSS_BUCKET_NAME=${OSS_BUCKET_NAME}"
                        echo "OSS_ENDPOINT=${OSS_ENDPOINT}"
                      } >> /tmp/fanfiction.env

                      # Verify .env file was created
                      if [ ! -f /tmp/fanfiction.env ]; then
                        echo "Error: Failed to create /tmp/fanfiction.env"
                        exit 1
                      fi
                      
                      echo "Environment file created successfully"
                      echo "Number of variables in .env file: $(wc -l < /tmp/fanfiction.env)"

                      echo "Starting Docker container..."
                      docker run -d --name fanfiction \
                        -p 8000:8000 \
                        --env-file /tmp/fanfiction.env \
                        --restart unless-stopped \
                        $IMAGE_NAME

                      # Wait for container to start
                      echo "Waiting for container to start..."
                      sleep 10

                      # verify env variables are accessible in container
                      echo "=== Environment Variables in Container ==="
                      docker exec fanfiction env | grep -E "DJANGO_SETTINGS_MODULE|SECRET_KEY|DEBUG|ADMIN_EMAIL|SENDGRID|OSS_|ALIYUN_" || echo "Warning: Some environment variables may be missing"

                      # Display logs
                      echo "=== Docker Container Logs ==="
                      docker logs fanfiction --tail 100

                      # Check container status
                      echo "=== Container Status ==="
                      docker ps -f name=fanfiction

                      # logout from docker hub
                      echo "Logging out from Docker Hub..."
                      docker logout

                      # Clean up sensitive file
                      rm -f /tmp/fanfiction.env
                      echo "Deployment completed successfully"
